<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Digital account tool for FNS">
<meta name="author" content="Federation Knowledge Sharing Research Group">
<title>NBC DID Account</title>
<link rel="icon" href="favicon.ico">
<link href="css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<style>
.hostcard-item {
  margin: 0.75rem 0;
  border: 1px solid white;
  padding: 0.75rem;
  border-radius: 0.25rem;
}

#addcard-auth {
  width: 50%;
  padding: 0.375rem 0.75rem;
  font-size: 1rem;
  font-weight: 400;
  line-height: 1.5;
  color: #212529;
  background-color: #fff;
  background-clip: padding-box;
  border: 1px solid #ced4da;
  appearance: none;
  border-radius: 0.25rem;
}

#addcard-content {
  width: 100%;
  padding: 0.375rem 0.75rem;
  height: 6rem;
  border-color: #eee;
  outline: none;
  resize: none;
}

.pagination .page-link {
  cursor: default;
}
</style>

<div class="modal" tabindex="-1" id="addcard-modal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">添加卡证</h5>
        <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div>为方便卡证维护，请您设置授权方标记（即，本卡证由谁授权的）。</div>
        <div class="mt-3"><input type="text" id="addcard-auth" placeholder="授权方"></div>
        <textarea class="mt-3 rounded-2" id="addcard-content" placeholder="请输入卡证的 16 进制内容字串"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary shadow-none" id="dlg-btn-addcard">添加</button>
      </div>
    </div>
  </div>
</div>

<nav class="navbar navbar-expand-md navbar-dark bg-dark pt-1 pb-0" id="nav-area">
  <div class="container-fluid">
    <a class="navbar-brand ps-3 pe-4" href="https://www.fn-share.com" target="_blank" id="brand-name">FNS</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="btn nav-link" name="about">关于</a>
        </li>
        <li class="nav-item">
          <a class="btn nav-link" name="hosting">账号</a>
        </li>
        <li class="nav-item">
          <a class="btn nav-link" name="manual">文档</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- top block: about -->
<div class="container-lg" name="block-about"><div class="row g-3 mt-2 pt-2 pb-2">

<h2>关于 NBC DID 账号</h2>
<div class="m-2">NBC DID 账号管理器是适用于联邦知识分享（Federation kNowledge Sharing, FNS）领域的个人账号管理工具，它基于 NBC 账号库（NBC Account Library，NAL）构建，是一套支持 DID 自主身份的账号系统。</div>
<div class="m-2">请注意，本软件目前只支持在桌面电脑的 chrome 浏览器中使用。</div>
<div class="m-2" id="wait-auth-list"></div>
</div></div>

<!-- top block: hosting -->
<div class="container-lg d-none" name="block-hosting"><div class="row g-3 mt-2 pt-2 pb-2">

<div class="container-fluid d-none" name="hosting-pre-restore">
  <h2 class="mt-2">在本机创建账号</h2>
  <p class="mt-4">手机号与助记语一起用于推导账号。助词语（即，脑词）是您最难忘，别人又难猜的一句话，请妥善保管助记语，它属于关键机密，恢复账号会用到。</p>
  <p class="mb-2">登录密码最小长度是 6 个字符，建议超过 8 个字符。</p>
  <div class="row mt-3">
    <form class="col-auto" onsubmit="return false" style="width:300px">
      <input class="form-control mt-3 shadow-none" type="text" autocomplete="username" placeholder="输入手机号" id="login-usr">
      <input class="form-control mt-3 shadow-none" type="password" autocomplete="current-password" placeholder="设置登录密码" id="login-psw">
      <input class="form-control mt-3 shadow-none" type="password" autocomplete="off" placeholder="再次输入密码" id="login-psw2">
      <textarea class="form-control mt-3 shadow-none" placeholder="输入 20 ~ 40 字助记语" id="mnemonic-word"></textarea>
    </form>
    <div class="w-100">&nbsp;</div>
    <div class="col-auto">
      <p><button type="button" class="btn btn-primary shadow-none ms-1" id="btn-create-acc"><span class="spinner-border spinner-border-sm d-none" role="status"></span> 创建账号 </button></p>
    </div>
  </div>
</div>

<div class="container-fluid d-none" name="hosting-pre-main"><div class="row">

<div class="col-sm-3 col-md-2 col-lg-2 pb-4">
  <div class="list-group text-center" id="list-tab" role="tablist">
    <a class="list-group-item list-group-item-action active" id="list-abstract-list" data-bs-toggle="list" href="#list-abstract" role="tab">摘要</a>
    <a class="list-group-item list-group-item-action" id="list-psw-list" data-bs-toggle="list" href="#list-psw" role="tab">账号密码</a>
    <a class="list-group-item list-group-item-action" id="list-real-list" data-bs-toggle="list" href="#list-real" role="tab">真身验证</a>
    <a class="list-group-item list-group-item-action" id="list-selfsign-list" data-bs-toggle="list" href="#list-selfsign" role="tab">自签护照</a>
    <a class="list-group-item list-group-item-action" id="list-policy-list" data-bs-toggle="list" href="#list-card" role="tab">卡证列表</a>
    <a class="list-group-item list-group-item-action" id="list-policy-list" data-bs-toggle="list" href="#list-policy" role="tab">策略定义</a>
    <a class="list-group-item list-group-item-action" id="list-log-list" data-bs-toggle="list" href="#list-log" role="tab">授权历史</a>
  </div>
</div>

<div class="col-sm-9 col-md-10 col-lg-10 pe-3"><div class="tab-content" id="nav-tabContent">

<div class="tab-pane fade show active" id="list-abstract" role="tabpanel">
<h2 class="mb-4">当前账号</h2>
<div class="alert alert-primary mb-2 text-break" role="alert">
  <span id="real-fp">真身指纹：</span><br>
  <span id="did-real">真身标识：</span><br>
  <span id="real-pub">真身账号：</span>
</div>
<h2 class="mt-5 mb-4">当前版本</h2>
<div class="alert alert-primary mb-2 text-break" role="alert">
  <span id="ver-no">库版本号：</span><br>
  <span id="ver-time">安装时间：</span>
</div>
</div>  <!-- end of #list-abstract  -->

<div class="tab-pane fade" id="list-psw" role="tabpanel">
<h2 class="mb-4">验证保留字</h2>
<p class="mb-2">请从弹出的列表中选择一个校验码，正确选择是取保留字校验码中有 1 个字符变换过的那一项，列表中其它项目均变换过 2 个以上字符。</p>
<p class="mb-2">点击下面按钮系统将发起保留字验证，如果选错项目，系统将立即上锁，此后用户需输入正确的登录密码才能解锁。提示：您可以借助故意选错校验码给系统上锁。</p>
<div class="mt-4 mb-4"><button type="button" class="btn btn-primary" id="btn-verify-rsvd">验证保留字</button></div>

<h2 class="mt-5 mb-4">查询保留字校验码</h2>
<p>保留字校验码从用户预设的手机号与登录密码推导而来，该校验码在验证保留字时会用到。</p>
<div class="mt-4 mb-4"><button type="button" class="btn btn-primary" id="btn-query-rsvd">查询验证码</button></div>

<h2 class="mt-5 mb-4">修改登录密码</h2>
<p>修改登录密码后，保留字校验码也会跟随变化。</p>
<form onsubmit="return false">
<div class="input-group mb-3" style="width:300px">
  <span class="input-group-text">当前密码</span>
  <input type="password" class="form-control" placeholder="输入密码用于授权" autocomplete="off" id="input-mod-psw">
</div>
<div class="input-group mb-3" style="width:300px">
  <span class="input-group-text">新设密码</span>
  <input type="password" class="form-control" placeholder="输入新密码" autocomplete="off" id="input-mod-psw2">
</div>
<div class="input-group mb-3" style="width:300px">
  <span class="input-group-text">再输密码</span>
  <input type="password" class="form-control" placeholder="再次输入新密码" autocomplete="off" id="input-mod-psw3">
</div>
</form>
<div class="mt-4 mb-2"><button type="button" class="btn btn-primary" id="btn-modi-acc">提交更改</button> &nbsp; <button type="button" class="btn btn-primary d-none" id="btn-rollback-acc">回退</button> &nbsp; <button type="button" class="btn btn-primary d-none" id="btn-renew-real">再次同步</button></div>
<p class="mb-4" style="color:red" id="hint-modi-acc"></p>
</div>  <!-- end of #list-psw -->

<div class="tab-pane fade" id="list-real" role="tabpanel">
<h2 class="mb-4">关于真身验证</h2>
<p class="mb-2">真身（Real Person）验证是 NBC DID 系统的必备环节，<strong>它用于确保被服务的对象是真实人类</strong>。NBC DID 真身验证要求至少采用手机短信实施验证（验证时还可选与特定的可信设备捆绑）。验证通过后，该社区的诸多第三方网站都使用同一个真身服务点（Real Server Point，RSP）获取类似于 <strong>护照颁发、护照验真、换绑手机号</strong> 等服务。</p>
<p class="mb-2">您应该在下面 “设置真身服务点” 指定服务点 URL 并完成真身验证，然后才能获得应用于诸多应用网站登录所需的<strong>可信护照服务</strong>。否则，你只能自行颁发自签护照（自签护照不是可信护照），只适用于少数网站。</p>
<p class="mb-2">更换真身服务点，相当于更换社区，每个社区只置设一个真身服务点。</p>
<p class="mb-2">提示：真身服务点（RSP）实施真身验证时，会记录您的手机号与可公开真身账号之间的关联关系。</p>

<h2 class="mt-5 mb-4">设置真身服务点</h2>
<div class="alert alert-primary mb-3 text-break" role="alert">
  <span>当前在用手机号：</span><span id="my-real-phone"></span><br>
  <span>可公开真身公钥：</span><span id="my-real-pub"></span><br>
  <span>可公开真身链码：</span><span id="my-real-chain"></span>
</div>
<div class="input-group mb-3" style="width:340px">
  <span class="input-group-text">https://</span>
  <input type="text" class="form-control text-truncate" autocomplete="off" id="input-realhost">
</div>
<div class="mb-4">
  <button type="button" class="btn btn-primary" id="btn-set-realhost">保存 URL</button>
  <button type="button" class="btn btn-success ms-2" id="btn-real-state">查询状态</button>
  <button type="button" class="btn btn-success ms-1" id="btn-stop-pspt">停用服务</button>
  <button type="button" class="btn btn-success ms-1" id="btn-real-auth">请求真身验证...</button>
</div>
</div>  <!-- end of #list-real -->

<div class="tab-pane fade" id="list-selfsign" role="tabpanel">
<h2 class="mb-4">关于自签护照</h2>
<p class="mb-2">自签护照（self-signed passport）是用户自行签名的护照，因为不需第三方机构签名，它可以随时生成、随意更换，隐私性更好，但可信性欠佳。</p>
<p class="mb-2">NAL 库始终配置一份自签护照，应用网站常用它表达当前用户的<strong>游客身份</strong>，您还可以指定昵称与头像。</p>

<h2 class="mt-5 mb-4">当前自签护照</h2>
<div class="alert alert-primary mb-3 text-break" role="alert">
  <span>身份序号：</span><span id="my-selfsign-no"></span><br>
  <span>身份公钥：</span><span id="my-selfsign-pub"></span><br>
</div>

<h2 class="mt-5 mb-4">更换自签护照</h2>
<div class="input-group mb-3" style="width:340px">
  <span class="input-group-text">序号</span>
  <input type="text" class="form-control text-truncate shadow-none" autocomplete="off" placeholder="若不指定将随机生成" id="input-selfsign-no">
</div>
<div class="mb-3">
  <button type="button" class="btn btn-primary" id="btn-set-selfsign">立即更换</button>
</div>

<h2 class="mt-5 mb-4">设置昵称与头像</h2>
<p class="mb-3">为游客身份设置昵称与头像，建议不要设置真实姓名与真实照片。</p>
<div class="input-group mb-3" style="width:340px">
  <span class="input-group-text">使用昵称</span>
  <input type="text" class="form-control text-truncate shadow-none" autocomplete="off" id="input-selfsign-nick">
</div>
<div class="input-group mb-3" style="width:340px">
  <input type="file" class="form-control shadow-none" id="input-select-avatar">
</div>
<div class="mb-3">
  <img class="ms-1" style="width:200px; height:200px; border:1px solid #ccc" id="img-avatar">
</div>
<div class="mb-3">
  <button type="button" class="btn btn-primary ms-1" id="btn-set-nick-avatar">保存</button>
</div>
</div>  <!-- end of #list-selfsign -->

<div class="tab-pane fade" id="list-card" role="tabpanel">
<h2 class="mb-4">卡证列表</h2>
<div class="d-none mt-5" id="no-hostcard-area">
  <p class="mb-3">尚无卡证。</p>
  <p><button type="button" class="btn btn-success shadow-none" id="btn-refresh-hostcard">刷新</button></p>
</div>
<div class="list-group mt-5 d-none" role="tablist" id="hostcard-table-area"></div>
<div class="mt-3 d-none" style="height: 3rem;" id="hostcard-page-area">
  <nav class="float-start pe-2"><ul class="pagination"></ul></nav>
</div>
<div class="alert alert-primary text-break mt-3 d-none" role="alert" id="hostcard-info-area"></div>
<div class="mt-3 mb-3 d-none" id="hostcard-op-area">
  <input type='text' style="width:10px; opacity:0; user-select:none;" id="edt-card-ctx" readonly>
  <button type="button" class="btn btn-success" id="btn-add-card">添加卡证</button>
</div>
</div>

<div class="tab-pane fade" id="list-policy" role="tabpanel">
<h2 class="mb-4">策略定义</h2>
<div class="list-group mt-5 d-none" role="tablist" id="website-table-area"></div>
<div class="mt-3 d-none" style="height: 3rem;" id="website-page-area">
  <nav class="float-end pe-2"><ul class="pagination"></ul></nav>
</div>
<div class="alert alert-primary text-break mt-3 d-none" role="alert" id="website-info-area"></div>
</div>

<div class="tab-pane fade" id="list-log" role="tabpanel">
<h2 class="mb-4">授权历史</h2>
<div class="d-none mt-5" id="no-signlist-area">
  <p class="mb-3">尚无授权项目。</p>
  <p><button type="button" class="btn btn-success shadow-none" id="btn-refresh-signlist">刷新</button></p>
</div>
<div class="list-group mt-5 d-none" role="tablist" id="signlist-table-area"></div>
<div class="mt-3 d-none" style="height: 3rem;" id="signlist-page-area">
  <nav class="float-end pe-2"><ul class="pagination"></ul></nav>
</div>
<div class="alert alert-primary text-break mt-3 d-none" role="alert" id="signlist-info-area"></div>
</div>

</div></div>  <!-- end of <div><div.tab-content>  -->
</div></div>  <!-- end of <div.container-fluid><div.row>  -->

</div></div>  <!-- end of <div.container[block-hosting]><div.row>  -->

<!-- top block: manual -->
<div class="container-lg d-none" name="block-manual"><div class="row g-3 mt-2 pt-2 pb-2">
<h2>参考文档</h2>
<div class="m-2 mt-3"><a target="_blank" href="/account-manager-manual/index.html">FNS 账号管理器使用手册</a></div>
<div class="m-2"><a target="_blank" href="/nbc-did-whitebook/index.html">NBC DID 技术白皮书</a></div>
<div class="m-2"><a target="_blank" href="/fn-faq/index.html">FNS FAQ</a></div>

<h2 class="mt-4">常用站点</h2>
<div class="m-2 mt-3"><a target="_blank" href="https://netlog.fn-share.com/">免费网志</a></div>
</div></div>

<div class="d-none"><input type="file" id="file_selector"></div>

<script src="js/jquery-3.6.0.slim.min.js"></script>
<script src="js/popper.min.js"></script>
<script src="js/bootstrap.min.js"></script>

<script src="js/nbc_base-0.1.min.js"></script>

<script>
const NAL = ( function() {

const NAL_BUFF_SIZE = 16;

var sw_call_idx_ = 0;

var sw_magic_   = null;
var sw_channel_ = {};   // { strategy_ver, host }
var sw_storage_ = null;
var sw_verInfo_ = null;

var _msg_buff = [];

window.addEventListener('message', function(ev) {
  if (ev.source === window && typeof ev.data == 'string' && ev.data.slice(0,8) === 'NAL_RPY:') {
    try {
      let obj = JSON.parse(ev.data.slice(8));
      _msg_buff.push([obj.id || 0,obj.result]);
      while (_msg_buff.length > NAL_BUFF_SIZE) _msg_buff.shift();
    }
    catch(e) {}
  }
});

const _NAL = {
  // NAL.call_(cmd,param).then(res => console.log(res))
  //   .catch(err => console.log(err))
  //   .finally(() => console.log('finally do something'))
  call_(cmd, param, wait) {
    sw_call_idx_ += 1;
    let new_id = sw_call_idx_;
    if (!wait) wait = 5000;  // default max wait 5 seconds
    
    let resolve_fn, reject_fn;
    let waitObj = new Promise( (resolve, reject) => {
      resolve_fn = resolve;
      reject_fn = reject;
    });
    
    let counter = 0;
    let taskId = setInterval( () => {
      counter += 250;
      if (counter >= wait) {
        clearInterval(taskId);
        console.log('NAL request timeout: ' + cmd);
        reject_fn(new Error('TIMEOUT'));
      }
      else {
        let succ = false, found = null, oldest = new_id - 128;
        for (let i=_msg_buff.length-1; i >= 0; i--) {
          let item = _msg_buff[i], itemId = item[0];
          if (itemId === new_id) {
            _msg_buff.splice(i,1);
            found = item[1];
            succ = true;
          }
          else if (itemId < oldest)
            _msg_buff.splice(i,1);  // remove too old reply item
        }
        
        if (succ) {
          clearInterval(taskId);
          resolve_fn(found);
        }
      }
    }, 250);
    
    if (!param) param = [];
    window.postMessage('NAL_REQ:'+JSON.stringify({id:new_id,cmd,param}));
    
    return waitObj;
  },
  
  verInfo(info) { // reconstruct json to avoid side effects
    if (info) sw_verInfo_ = info;  // set ver info
    return sw_verInfo_;
  },
  
  swMagic(callback, magic, wait) {
    let oldValue = sw_magic_;
    if (!callback) {   // read sw_magic_
      if (typeof magic == 'number')
        sw_magic_ = magic;
      return oldValue;
    }
    // else, reset sw_magic_
    
    sw_magic_ = null;
    _NAL.call_('regist_magic',null,wait || 5000).then( res => {  // default max wait 5 seconds
      sw_magic_ = res.sw_magic;
      sw_channel_ = { strategy_ver:res.strategy_ver, host:res.host };
      sw_storage_ = res.storage;
      sw_verInfo_ = res.ver_info;
      callback(sw_magic_);
    }).catch(err => callback(null));
    
    return oldValue;
  },
  
  swHost() {
    return sw_channel_.host || '';
  },
  
  strategyVer() {
    return sw_channel_.strategy_ver;  // null means not ready
  },
  
  swStorage() {
    return sw_storage_;
  },
  
  waitReady(wait) {
    let resolve_fn, reject_fn;
    let waitObj = new Promise( (resolve, reject) => {
      resolve_fn = resolve;
      reject_fn = reject;
    });
    
    _NAL.swMagic( magic => {
      if (magic === null)
        reject_fn(new Error('FAILED'));
      else resolve_fn(sw_verInfo_);
    }, null, wait);
    
    return waitObj;
  },
};

return _NAL;
})();

NAL.dialog = ( () => {

let inShowing = false;

NAL.dialogShowing = function() { return inShowing; };

function noResponse(e) {
  e.stopPropagation();
}

let maskNode = (() => {
  let node = document.querySelector('#nal-mask');
  if (!node) {
    node = document.createElement('div');
    node.setAttribute('id','nal-mask');
    node.setAttribute('style','display:none; background:rgba(0,0,0,0.5); position:fixed; z-index:1056; left:0; top:0; right:0; bottom:0; padding:0; margin:0; border-width:0;');
    node.onclick = node.ondblclick = node.onmousedown = node.ontouchstart = noResponse;
    document.body.appendChild(node);
  }
  return node;
})();

function closeDialog() {
  document.querySelectorAll('#nal-mask > div[name^="dlg-"]').forEach( node => {
    node.style.display = 'none';
  });
  maskNode.style.display = 'none';
  inShowing = false;
}

let nalDialogResolve = null, nalDialogReject = null;
let nalCheckPassId = 0;

// define NAL.dialog(name,args)
return ( (name, args) => {
  if (!name) return inShowing;  // query in showing or not
  
  if (inShowing) {
    return new Promise( function(resolve, reject) {
      reject(new Error('SYSTEM_BUSY'));
    });
  }
  
  let task = new Promise( function(resolve, reject) {
    nalDialogResolve = resolve; // affects history task, it is safe since only one dialog in showing always
    nalDialogReject = reject;
  });
  let dialog = null, startupFn = null;
  
  if (name == 'pass') {
    let pswDialog = maskNode.querySelector('div[name="dlg-pass"]');
    if (!pswDialog) {
      pswDialog = document.createElement('div');
      pswDialog.setAttribute('name','dlg-pass');
      pswDialog.setAttribute('style','display:none; background:white; position:relative; width:400px; left:calc(50% - 200px); top:68px; border-radius:0.25rem;');
      pswDialog.innerHTML = '<div style="height:4.5rem"><span style="display:inline-block; float:left; margin:1.25rem; font-size:1.25rem; font-weight:500;">请输入 NBC 账号密码</span><button name="btn-cancel" style="display:inline-block; border-width:0; background-color:#fff; font-size:2.25rem; font-weight:200; color:#000; opacity:0.5; float:right; margin:0 8px;">&times;</button></div><div style="border:solid rgba(0,0,0,0.2); border-width:1px 0; padding:1.25rem;"><form onsubmit="return false"><input type="password" style="width:280px; outline:none; padding:0.375rem 0.75rem; color:#212529; font-size:1rem; font-weight:400; line-height:1.5; background-clip:padding-box; background-color:#fff; border:1px solid #ced4da; appearance:none; border-radius:0.25rem;" placeholder="密码长度需超过 6 个字符" autocomplete="off"></form></div><div style="padding:0.75rem 1.25rem 1rem; text-align:right; user-select:none; font-size:1rem; line-height:1.5;"><button name="btn-confirm" style="border:1px solid transparent; margin:0.25rem; padding:0.375rem 0.75rem; text-align:center; color:#fff; background-color:#0d6efd; border-color:#0d6efd; border-radius:0.25rem;">确定</button></div>';
      maskNode.appendChild(pswDialog);
      
      let node = pswDialog.querySelector('input[type="password"]');
      node.onkeypress = ( ev => {
        if (ev.keyCode == 13) {
          let s = ev.target.value;
          if (s.length < 6) return alert('密码长度未满足要求');
          
          ev.target.value = '';
          closeDialog();
          nalDialogResolve(s);
        }
      });
      
      node = pswDialog.querySelector('button[name="btn-cancel"]');
      node.onmouseover = (ev => ev.target.style.opacity = '1');
      node.onmouseout = (ev => ev.target.style.opacity = '0.5');
      node.onclick = ( ev => {
        pswDialog.querySelector('input[type="password"]').value = '';
        closeDialog();
        nalDialogReject(new Error('CANCELED'));
      });
      
      node = pswDialog.querySelector('button[name="btn-confirm"]');
      node.onmouseover = (ev => ev.target.style.opacity = '0.8');
      node.onmouseout = (ev => ev.target.style.opacity = '1');
      node.onclick = ( ev => {
        let edt = pswDialog.querySelector('input[type="password"]');
        let s = edt.value;
        if (s.length < 6) return alert('密码长度未满足要求');
        
        edt.value = '';
        closeDialog();
        nalDialogResolve(s);
      });
    }
    
    dialog = pswDialog;
    startupFn = (() => pswDialog.querySelector('input[type="password"]').focus());
  }
  
  else if (name == 'rsvd') {
    if (!args.length) return null; // fatal error, should not happen
    let rsvdDialog = maskNode.querySelector('div[name="dlg-rsvd"]');
    if (!rsvdDialog) {
      rsvdDialog = document.createElement('div');
      rsvdDialog.setAttribute('name','dlg-rsvd');
      rsvdDialog.setAttribute('style','display:none; background:white; position:relative; width:300px; left:calc(50% - 150px); top:68px; border-radius:0.25rem;');
      rsvdDialog.innerHTML = '<div style="height:4.5rem"><span style="display:inline-block; float:left; margin:1.25rem; font-size:1.25rem; font-weight:500;">请选择保留字</span><button name="btn-cancel" style="display:inline-block; border-width:0; background-color:#fff; font-size:2.25rem; font-weight:200; color:#000; opacity:0.5; float:right; margin:0 8px;">&times;</button></div><div name="rsvd-body" style="border:solid rgba(0,0,0,0.2); border-width:1px 0 0; padding:1.25rem 0 2rem; user-select:none; font-family:monospace; font-size:1rem; line-height:1.5; text-align:center;"></div>';
      maskNode.appendChild(rsvdDialog);
      
      let node = rsvdDialog.querySelector('button[name="btn-cancel"]');
      node.onmouseover = (ev => ev.target.style.opacity = '1');
      node.onmouseout = (ev => ev.target.style.opacity = '0.5');
      node.onclick = ( ev => {
        closeDialog();
        nalDialogReject(new Error('CANCELED'));
      });
      
      node = rsvdDialog.querySelector('div[name="rsvd-body"]');
      let btn = document.createElement('button');
      btn.setAttribute('style','border:1px solid transparent; margin:0.25rem 0.5rem; padding:0.5rem 0.75rem; font-weight:500; color:#fff; background-color:#198754; border-color:#198754; border-radius:1.5rem;');
      
      let i = 0, btn2 = btn;
      while (true) {
        btn2.innerHTML = args[i] || ''; // 3~5 number, no need escape
        btn2.onmouseover = rsvdMouseOver;
        btn2.onmouseout = rsvdMouseOut;
        btn2.onclick = rsvdSelected;
        node.appendChild(btn2);
        
        if (i == 2 || i == 5)
          node.appendChild(document.createElement('br'));
        
        i += 1;
        if (i >= 9) break;
        btn2 = btn.cloneNode(false);
      }
      
      function rsvdMouseOver(ev) {
        ev.target.style.opacity = '0.8';
      }
      function rsvdMouseOut(ev) {
        ev.target.style.opacity = '1';
      }
      function rsvdSelected(ev) {
        let ret = ev.target.innerHTML; // 3~5 number
        closeDialog();
        nalDialogResolve(ret);
      }
    }
    else {
      let items = rsvdDialog.querySelectorAll('div[name="rsvd-body"] > button');
      args.forEach( (item,idx) => {
        if (idx < items.length) items[idx].innerHTML = item;
      });
    }
    
    dialog = rsvdDialog;
  }
  
  if (!dialog) return null;
  
  inShowing = true;
  maskNode.style.display = 'block';
  dialog.style.display = 'block';
  if (startupFn) startupFn();
  
  return task;
});   // end of return xx

})(); // assign to NAL.dialog

NAL.call = function(cmd, param, wait) {  // wrap WAIT_PASS process on NAL.call_()
  return NAL.call_(cmd,param,wait).then( res => {
    if (res === 'WAIT_PASS')
      return passAndCall(1);
    else return res;
  });
  
  function passAndCall(counter) {
    return NAL.dialog('pass').then( psw => {
      return NAL.call_('config_acc',[psw]).then( res => {
        if (res === 'OK')
          return NAL.call_(cmd,param,wait);
        else if (res === 'WAIT_PASS') {
          if (counter >= 3)  // max try 3 times
            throw Error('PASSWORD_ERROR');
          return passAndCall(counter+1);
        }
        else throw Error('SYS_NOT_READY'); // can catch by: NAL.call(...).catch(err => ...)
      });
    }); // maybe throw Error('CANCELED') when inputting psw canceled
  }
};
</script>

<script>
const ECDH = require('create-ecdh')('secp256k1');
const CryptoJS = require('crypto-js');
const CreateHash = require('create-hash');
const Buffer = require('safe-buffer').Buffer;
const bip32 = require('bip32');

const secp256k_order = BigInt('0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141');

function htmlEscape(text) { 
  return text.replace(/[<>"&]/g, function(match, pos, originalText) { // "
    if (match == '<')
      return '&lt;';
    else if (match == '>')
      return '&gt;';
    else if (match == '&')
      return '&amp;';
    else if (match == '"')
      return '&quot;';
  });
}

async function wait__(promise_obj, wait) {
  let abort_fn = null;
  let abortable_promise = Promise.race([ promise_obj,
    new Promise( function(resolve, reject) {
      abort_fn = function() { reject(new Error('TIMEOUT')) };
    })
  ]);
  
  setTimeout(()=>abort_fn(),wait || 30000);
  return abortable_promise;
}

function url_fetch(url, callback, options, timeout) {
  wait__(fetch(url,options),timeout).then( res => {
    if (res.status == 200)
      return res.json();
    else return null;   // ignore other res.status
  }, e => null ).then( data => {
    if (callback) callback(data);  // data can be null
  });
}

function generateRand(num) {
  let ret = Buffer.alloc(num,0);
  for (let i=0; i < num; i++) {
    ret[i] = Math.floor(Math.random() * 256);  // 0 ~ 255
  }
  return ret;
}

function gen_ecdh_key(pubkey33, re_gen) {
  // ECDH.setPrivateKey(big.numToBuf(bigN));  // for debuging
  if (re_gen) ECDH.generateKeys();
  
  let pubKeyPoint = ECDH.getPublicKey();
  let nonce_x = pubKeyPoint.slice(1,33);  // nonce_y = pubKeyPoint.slice(33,65)
  let flag = pubKeyPoint[64] & 0x01;
  let targ_x = ECDH.computeSecret(pubkey33);
  return [flag, nonce_x, targ_x];
}

function wrapCryptoBuf(msg) {
  if (msg.words instanceof Array)  // msg is instance of CryptoJS.lib.WordArray
    return msg;
  else if (msg.buffer instanceof ArrayBuffer)  // msg is instance of Buffer
    return CryptoJS.lib.WordArray.create(msg);
  else return CryptoJS.enc.Utf8.parse(msg);    // assume msg is utf-8 string
}

function AesCbcEncrypt(prv, iv, msg) {
  prv = wrapCryptoBuf(prv);
  iv = wrapCryptoBuf(iv);
  msg = wrapCryptoBuf(msg);
  
  let encrypted = CryptoJS.AES.encrypt(msg, prv, {
    iv: iv,
    mode: CryptoJS.mode.CBC,
    padding: CryptoJS.pad.ZeroPadding
  });
  // encrypted.toString() is base64-string, encrypted.ciphertext.toString() is hex-string
  return encrypted.ciphertext;  // return CryptoJS.lib.WordArray
}

function AesCbcDecrypt(prv, iv, msg) { // msg must be base64 string
  prv = wrapCryptoBuf(prv);
  iv = wrapCryptoBuf(iv);
  
  return CryptoJS.AES.decrypt(msg, prv, {
    iv: iv,
    mode: CryptoJS.mode.CBC,
    padding: CryptoJS.pad.NoPadding  // CryptoJS.pad.ZeroPadding
  });  // return CryptoJS.lib.WordArray
}

function encryptMsg(k_iv, msg) {
  return AesCbcEncrypt(k_iv.slice(0,16),k_iv.slice(16,32),msg);
}

function hash256_d(s) { // make double hash, s is utf-8 string or Buffer
  if (!(s instanceof Buffer)) {
    if (typeof s != 'string') s = s + '';
    s = Buffer.from(s,'utf-8');
  }
  return CreateHash('sha256').update(CreateHash('sha256').update(s).digest()).digest();
}

function ripemdHash(buf) {
  let ha = CreateHash('sha256').update(buf).digest();
  return CreateHash('ripemd160').update(ha).digest();
}

//----

var holding_sw_id = 0;

function holdingSW() {
  if (holding_sw_id) clearInterval(holding_sw_id);
  
  let authList = $('#wait-auth-list');
  holding_sw_id = setInterval( () => {
    NAL.call_('list_wait_sign',[NAL.swMagic()]).then( res => {
      if (res === 'WAIT_PASS') {
        if (authList.find('.card[name="WAIT_PASS"]').length == 0) {
          authList.html('<div class="card m-1" name="WAIT_PASS" style="width:22rem"><div class="card-body"><h5 class="card-title">account.nb-chain.cn</h5><p class="card-text"><span>授权给: </span><code>pass</code></p><form onsubmit="return false"><input class="form-control form-control-md mt-3" type="password" autocomplete="off" placeholder="输入密码并击回车" style="width:16rem"></form></div></div>');
          authList.find('input[type="password"]').on('keypress', ev => {
            if (ev.keyCode == 13) {
              let psw = $(ev.target).val();
              if (!psw) return alert('密码不能为空');
              NAL.call_('config_acc',[psw]).then( res => {
                if (res === 'WAIT_PASS') return alert('密码不正确');
                if (res === 'OK') authList.html('');
              });
            }
          });
        }
      }
      else if (res instanceof Array) {
        let waitItems = res;
        if (!waitItems.length)
          authList.html('');
        else {
          waitItems.forEach( (item,idx) => {
            if (!item || !item.host) return;
            if (authList.find('.card[name="'+item.host+'"]').length == 0) {
              let node = $(`<div class="card m-1" name="${item.host}" style="width:22rem"><div class="card-body"><h5 class="card-title">${item.host} <button type="button" class="btn-close shadow-none" style="float:right;width:0.5em;height:0.5em"></button></h5><p class="card-text"><span>授权给: </span><code>${item.realm}</code></p><form onsubmit="return false"><input class="form-control form-control-md mt-3" type="password" autocomplete="off" placeholder="输入密码并击回车" style="width:16rem"></form></div></div>`);
              authList.append(node);
              node.find('input[type="password"]').on('keypress', ev => {
                if (ev.keyCode == 13) {
                  let nd = $(ev.target);
                  let psw = nd.val();
                  if (!psw) return alert('密码不能为空');
                  
                  let targHost = nd.parents('.card').attr('name');
                  if (!targHost) return;
                  
                  NAL.call_('do_wait_sign',[psw,NAL.swMagic(),targHost]).then( res => {
                    if (typeof res == 'string') {
                      if (res == 'WAIT_PASS') return alert('密码不正确');
                      if (res == 'OK')
                        authList.html('');
                      else console.log('meet error:' + res);
                    }
                  });
                }
              });
              
              node.find('button').on('click', ev => {
                let targHost = $(ev.target).parents('.card').attr('name');
                if (!targHost) return;
                NAL.call('rmv_wait_sign',[NAL.swMagic(),targHost]).then( res => {
                  if (typeof res == 'string') {
                    if (res == 'OK')
                      authList.html('');
                    else console.log('meet error:' + res);
                  }
                });
              });
            }
          });
          
          authList.find('.card').each( (idx,node) => {
            node = $(node);
            let name = node.attr('name');
            if (!waitItems.find(x => name === x.host))
              node.remove();  // slient remove no using node
          });
        }
      }
    }).catch( e => {
      console.log(e);
      clearInterval(holding_sw_id);
      holding_sw_id = 0;
    });
  }, 2500);  // run every 2.5 seconds
}

function unholdSW() {
  if (holding_sw_id) {
    clearInterval(holding_sw_id);
    holding_sw_id = 0;
  }
}

var _currAlterOff = 0;

function showHostingTask(task) {
  let targName = 'hosting-pre-' + task;
  let nodes = $('body > div[name="block-hosting"]').find('div[name^="hosting-pre-"]');
  nodes.each( (idx,node) => {
    const nd = $(node);
    nd.toggleClass('d-none',nd.attr('name') != targName);
  });
  
  if (task == 'main') {
    NAL.swMagic( magic => {
      if (typeof magic != 'number')
        return alert('申请 service worker 事务 ID 出错');
      
      NAL.call('acc_summary',[magic],20000).then( res => {
        if (typeof res == 'string')
          alert('查询账号失败：' + res);
        else showAccount(res);
      });
    });
  }
  
  function showAccount(info) {
    // step 1: show account info
    _currAlterOff = info.alternate_off || 0;
    
    $('#did-real').text('真身标识：' + info.did_realid);   // alt/0/0
    $('#real-fp').text('真身指纹：' + info.real_figerprint);
    $('#real-pub').text('真身账号：' + info.real_pubkey);
    
    let tm = new Date(info.install_time * 1000);
    $('#ver-no').text('库版本号：NAL v' + info.ver);
    $('#ver-time').text('安装时间：' + tm.toLocaleString());
    
    // step 2: start app
    initAppLayer(info);
  }
}

function checkPhoneNo(sPhone) {
  if (sPhone.search(/^\d+$/) == -1 || sPhone.length <= 7 || sPhone.length >= 15)
    return false;
  else return true;
}

function tempDisableBtn(targ) {
  if (!targ) return;
  let node = $(targ);
  node.attr('disabled',true); // temporary disable button to avoid second-click
  setTimeout( () => node.attr('disabled',false), 2000);
}

var all_nav_items = $('#navbarSupportedContent .nav-link');

function _navClick(navName) {
  if (!navName) return;
  
  $('body > div[name^="block-"]').each( (idx,node) => {
    node = $(node);
    if (node.attr('name') == 'block-'+navName)
      node.removeClass('d-none');
    else node.addClass('d-none');
  });
  
  all_nav_items.each( (idx,node) => {
    node = $(node);
    if (node.attr('name') === navName)
      node.addClass('active');
    else node.removeClass('active');
  });
}

function createAccount(targBtn) {
  if (NAL.swMagic() === null)
    return alert('NAL 未就绪');
  
  // step 1: prepare phone, mnemonic, password
  let mnemonic = $('#mnemonic-word').val();
  mnemonic = Buffer.from(mnemonic);
  if (mnemonic.length < 12)
    return alert('助记词太短');
  
  let phoneNo = $('#login-usr').val().trim();
  if (!checkPhoneNo(phoneNo))
    return alert('手机号格式错误');
  let psw = $('#login-psw').val();
  let psw2 = $('#login-psw2').val();
  if (psw !== psw2)
    return alert('两次输入密码不一致');
  if (psw.length < 6)
    return alert('密码格式错误：密码长度要求超过 6');
  
  let loadingEle = $(targBtn).find('span.spinner-border');
  loadingEle.removeClass('d-none');  // show busy
  
  // step 2: create DEV-ACC, PSW-ACC
  let ha = CreateHash('sha256').update(mnemonic).digest();
  let devBip = bip32.fromSeed(Buffer.concat([Buffer.from(phoneNo+':'),ha]));
  devBip.chainCode = Buffer.alloc(32,0); // set ZERO to keep same to TEE's implementation 
  
  // step 3: create ALT-ACC
  let ha2 = CreateHash('sha256').update(Buffer.from('DID_CHILD:'));
  ha2 = ha2.update(devBip.privateKey.slice(0,16)).digest().slice(0,4);
  let alternate_no = parseInt(ha2.toString('hex'),16);     // alt_offset16 = 0
  alternate_no = 0x80000000 + (alternate_no & 0x7fffffff); // can not use `no | 0x80000000`
  
  let altBip = devBip.derive(alternate_no);
  let altHa = Buffer.concat([Buffer.from('NBC_DID:'+phoneNo+':'),altBip.publicKey]);
  altHa = CreateHash('sha256').update(CreateHash('sha256').update(altHa).digest()).digest();
  
  // step 4: forget mnemonic, password and devBip account
  let figerprint = ripemdHash(devBip.publicKey).slice(0,6);
  $('#mnemonic-word').val('');
  $('#login-psw').val('');
  $('#login-psw2').val('');
  mnemonic = devBip = null; // just for safety
  
  let pswBip = bip32.fromSeed(generateRand(32));
  let hosting = altBip.privateKey.toString('hex') + altHa.toString('hex');
  hosting += pswBip.privateKey.toString('hex') + pswBip.chainCode.toString('hex');
  
  // step 6: save account to SW
  let accInfo = { phone: phoneNo,
    alternate_no: alternate_no & 0x7fffffff,
    alternate_off: 0,
    figerprint: figerprint.toString('hex'),  // DEV-ACC
    hosting_data: hosting,
  };  // will add more: rsvd_list, rsvd_index, name, psw_pubkey_head, regist_time
  NAL.call_('save_account',[psw,accInfo],10000).then( res => {
    loadingEle.addClass('d-none');
    
    if (res == 'SW_NOT_READY') {
      alert('SW 未就绪');
    }
    else if (res !== 'OK')
      alert('保存账号失败');  // normally would not happen 
    else {
      NAL.call_('ver_info').then( data2 => {
        if (data2 && data2.acc_type) {
          NAL.verInfo(data2);
          showHostingTask('main');
          alert('创建账号成功');
        }
        // else, do nothing, silent process
      });
    }
  });
}

$( () => {
  all_nav_items.on( 'click', ev => _navClick($(ev.target).attr('name')) );
  _navClick('about');
  
  $('#btn-create-acc').on('click', ev => {
    createAccount(ev.target);
  });
  
  NAL.waitReady(5000).then( verInfo => {
    if (verInfo === null) {
      console.log('BIP account is not ready.');
      showHostingTask('restore');
    }
    else {
      console.log('BIP account is ready.');
      showHostingTask('main');
    }
  }).catch( e => {
    if (e.message == 'FAILED')
      alert('未发现 NAL 插件');
  });
});

var curr_real_id = '';

function initAppLayer(info) {
  curr_real_id = info.did_realid;
  holdingSW();
  
  // following will be defined later
  showRealAccount(info);
  showSelfSignAcc(info);
  jumpHostcardPage(0,true);
  tryRenewWebList(true);
  tryRenewSignList(true);
}
</script>

<script>
//---- account management

function shuffle(arr) {
  let i = arr.length, t, j;
  while (i) {
    j = Math.floor(Math.random() * i--);
    t = arr[i]; arr[i] = arr[j]; arr[j] = t;  // swap arr[i] and arr[j]
  }
}

$( () => {
  $('#btn-verify-rsvd').on('click', ev => {
    NAL.call('list_rsvd').then(afterGetList);
    
    function afterGetList(rsvdList) {
      if (typeof rsvdList == 'string') {
        if (rsvdList == 'WAIT_PASS' || rsvdList == 'NEED_PASS') {
          NAL.dialog('pass', psw => {
            NAL.call('list_rsvd',[psw]).then(afterGetList);
          }).catch(e => null);
        }
      }
      else if (!(rsvdList instanceof Array) || !rsvdList.length)
        alert('获取保留字列表出错');
      else showAndVeriRsvd(rsvdList);
    }
    
    function showAndVeriRsvd(rsvdList) {
      shuffle(rsvdList); // rsvdList must be an Array
      NAL.dialog('rsvd',rsvdList).then( res => {
        NAL.call_('check_rsvd',[res]).then(res2 => {
          if (!res2) alert('验证失败');
        });
      }).catch(e => null);
    }
  });
  
  $('#btn-query-rsvd').on('click', ev => {
    NAL.dialog('pass').then( psw => {
      NAL.call('get_rsvd',[psw]).then( res => {
        if (typeof res == 'string') {
          if (res == 'NEED_PASS')
            alert('操作失败：密码不正确');
          else if (res == 'NOT_READY')
            alert('操作失败：账号未就绪');
          else if (res.length <= 5)
            alert('保留字的校验码为：'+res);
        }
      });
    }).catch(e => null);
  });
  
  $('#btn-modi-acc').on('click', ev => {
    // step 1: check inputs
    let newPsw = $('#input-mod-psw2').val();
    let newPsw2 = $('#input-mod-psw3').val();
    if (newPsw != newPsw2)
      return alert('两次输入的新密码不匹配');
    
    let currPsw = $('#input-mod-psw').val();
    if (currPsw.length < 6)
      return alert('当前密码长度不足，要求超过 6 个字符');
    if (newPsw.length < 6)
      return alert('新设密码长度不足，要求超过 6 个字符，建议取 8 个以上字符');
    
    tempDisableBtn(ev.target);
    
    // step 2: change psw and rsvd
    NAL.call_('set_acc_psw',[NAL.swMagic(),currPsw,newPsw]).then( res => {
      if (res === 'WAIT_PASS')
        alert('操作失败：密码不正确');
      else if (res == 'OK') {
        alert('设置成功');
        $('#input-mod-psw').val('');
        $('#input-mod-psw2').val('');
        $('#input-mod-psw3').val('');
      }
      else alert('操作失败：' + res);
    });
  });
});
</script>

<script> //---- set real server point and crypto server point
function showRealAccount(info) {
  $('#my-real-phone').text(info.phone);
  $('#my-real-pub').text(info.real_pubkey);
  $('#my-real-chain').text(info.real_chaincode);
  
  $('#input-realhost').val(info.real_sp);
}

$( () => {
  $('#btn-set-realhost').on('click', ev => {
    let url = $('#input-realhost').val().trim();
    if (url.slice(-1) == '/') url = url.slice(0,-1);
    
    wait__(fetch('https://' + url + '/cards/managers'),30000).then( res => {
      if (res.status == 200)
        return res.json();
      else return null;
    }, e => null).then( data => {
      if (data && data.rsp_admin_pubkey) {
        NAL.call_('set_real_managers',[NAL.swMagic(),url,data]).then( res2 => {
          if (res2 === 'OK')
            alert('更改成功');
          else alert('操作失败');
        });
      }
      else alert('查询真身服务点管理员账号失败，请检查网络');
    });
  });
  
  $('#btn-real-state').on('click', ev => {
    if (!curr_real_id) return;  // not ready yet
    let url = $('#input-realhost').val().trim();
    if (!url) return alert('请先指定真身服务点 URL');
    
    url = 'https://' + url;
    if (url.slice(-1) == '/') url = url.slice(0,-1);
    
    tempDisableBtn(ev.target);
    wait__(fetch(url+'/cards/disabling?id='+curr_real_id),30000).then( res => {
      if (res.status == 200)
        return res.json();
      else if (res.status == 400)
        return res.text();
      else return null;
    }, e => null).then( data => {
      if (data === null || typeof data?.state != 'number') {
        if (typeof data == 'string')
          alert('查询失败：' + data);
        else alert('查询失败');
      }
      else {
        if (data.state === 0)
          alert('真身服务状态正常');
        else if (typeof data.last_disable == 'number') {
          let tm = new Date(data.last_disable * 1000);
          alert(`真身服务从 ${tm.toLocaleString()} 开始已停用`);
        }
      }
    });
  });
  
  $('#btn-stop-pspt').on('click', ev => {
    if (!curr_real_id) return;  // not ready yet
    let url = $('#input-realhost').val().trim();
    if (!url) return alert('请先指定真身服务点 URL');
    
    url = 'https://' + url;
    if (url.slice(-1) == '/') url = url.slice(0,-1);
    
    if (!confirm('停用真身服务后，您在该服点将无法申请护照，确认要继续执行停用吗？')) return;
    
    NAL.dialog('pass').then( psw => {
      NAL.call_('sign_disabling',[NAL.swMagic(),psw]).then( res => {
        if (typeof(res) == 'string') {
          if (res == 'NEED_PASS')
            alert('密码不正确');
          else alert('账号异常');
          return;
        }
        // else, res is {time,account,signature}
        
        wait__(fetch(url+'/cards/disabling',{method:'POST',body:JSON.stringify(res)}),
        30000).then( res2 => {
          if (res2.status == 200)
            return res2.json();
          else {
            if (res2.status == 400) {
              res2.text().then( desc => {
                if (desc == 'INVALID_TIME')
                  alert('时间不匹配');
                else if (desc == 'NO_ACCOUNT')
                  alert('账号不存在');
                else if (desc == 'ALREADY_DISABLED') {
                  $('#btn-stop-pspt').addClass('disabled');
                  alert('服务早已停用');
                }
                else if (desc == 'WRITE_DB_FAILED')
                  alert('写数据错误，请稍候重试');
                else alert('提交请求失败：' + desc);
              });
            }
            else if (res2.status == 401)
              alert('鉴权失败');
            else alert('提交请求失败');
            return null;
          }
        }, e => {
          alert('提交失败，请检查网络');
          return null;
        }).then( data => {
          if (data === null) return;
          if (data.result == 'success') {
            $('#btn-stop-pspt').attr('disabled',true);
            alert('停用真身服务成功');
          }
        });
      });
    }).catch( e => null );
  });
  
  $('#btn-real-auth').on('click', ev => {
    let url = $('#input-realhost').val().trim();
    if (!url) return alert('请先指定真身服务点 URL');
    
    url = 'https://' + url;
    if (url.slice(-1) == '/') url = url.slice(0,-1);
    url += '/users/regist?phone=' + $('#my-real-phone').text();
    url += '&pubkey=' + $('#my-real-pub').text();
    url += '&chain=' + $('#my-real-chain').text();
    
    window.open(url,'_blank');
  });
});
</script>

<script> //---- config selfsign account
function showSelfSignAcc(info) {
  $('#my-selfsign-no').text(info.selfsign_no+'');
  $('#my-selfsign-pub').text(info.selfsign_pubkey);
  
  NAL.call_('nick_avatar',['200x200']).then( res => {
    let nick = '', imgSrc = null;
    if (res && typeof res.nickname == 'string') {
      nick = res.nickname;
      if (res.avatar) imgSrc = res.avatar;
    }
    if (!imgSrc) imgSrc = 'img/default_avatar.png';
    
    $('#input-selfsign-nick').val(nick);
    $('#img-avatar').attr('src',imgSrc);
  });
}

$( () => {
  $('#btn-set-selfsign').on('click', ev => {
    let no = 0;
    let s = $('#input-selfsign-no').val().trim();
    if (s) {
      no = parseInt(s);
      if (isNaN(no))
        no = 0;
      else no = no & 0x7fffffff;
    }
    
    tempDisableBtn(ev.target);
    NAL.call_('set_selfsign',[NAL.swMagic(),no]).then( res => {
      if (res && res.result === 'OK') {
        $('#my-selfsign-no').text(res.selfsign_no+'');
        $('#my-selfsign-pub').text(res.selfsign_pubkey);
        alert('更换自签护照成功');
      }
      else {
        if (typeof res == 'string')
          alert('调用失败：' + res);
        else alert('更换自签护照失败');
      }
    });
  });
  
  $('#input-select-avatar').on('change', ev => {
    if (typeof FileReader == 'undefined')
      return alert('浏览器不支持 FileReader');
    
    var reader = new FileReader();
    var aFile = ev.target.files[0];
    
    readOneFile(aFile, function(fContent,fName,fSize) {
      if (fContent && fContent.slice(0,5) == 'data:' && fContent.slice(5,11) == 'image/') {
        var imgNode = $('#img-avatar');
        imgNode.attr('src',fContent);
      }
      else alert('未知格式，请选取图片文件');
    },300);
    
    function readOneFile(aFile, callback) {
      reader.onload = function(e) {
        callback(this.result,aFile.name,aFile.size);
      };
      reader.readAsDataURL(aFile);
    }
  });
  
  $('#btn-set-nick-avatar').on('click', ev => {
    let nick = $('#input-selfsign-nick').val().trim();
    if (nick.length > 24) return alert('昵称太长');
    
    let imgNode = $('#img-avatar')[0];
    let s200 = getAvatarImg(200,200,imgNode);
    let s160 = getAvatarImg(160,160,imgNode);
    let s120 = getAvatarImg(120,120,imgNode);
    let s80 = getAvatarImg(80,80,imgNode);
    let s48 = getAvatarImg(48,48,imgNode);
    let s32 = getAvatarImg(32,32,imgNode);
    
    NAL.call_('set_nick_avatar',[NAL.swMagic(),nick,s200,s160,s120,s80,s48,s32]).then( res => {
      if (res && res.result === 'OK')
        alert('保存配置成功');
      else {
        if (typeof res == 'string')
          alert('保存失败：' + res);
        else alert('保存失败');
      }
    });
    
    function getAvatarImg(wd, hi, imgNode) {
      let cavNode = document.createElement('CANVAS');
      cavNode.width = wd;
      cavNode.height = hi;
      
      let ctx = cavNode.getContext('2d');
      ctx.fillStyle = 'white';
      ctx.fillRect(0,0,cavNode.width,cavNode.height);
      ctx.drawImage(imgNode,0,0,wd,hi);
      return cavNode.toDataURL('image/jpeg',1); // 0.92
    }
  });
});
</script>

<script>
//---- list cards

var curr_hostcard = [];
var hostcard_pg_idx = 0;

let _addCardModal = new bootstrap.Modal($('#addcard-modal'),{backdrop:'static',keyboard:true});

function scanCardTag(card, tag) {
  let off = 4, n = card.length;
  while (off < n) {
    let t = card[off], len = card[off+1];
    if (t === tag) return card.slice(off+2,off+2+len);
    off += (2+len);
  }
  return null;  // not found
}

function jumpHostcardPage(currIdx, renew) {
  if (renew) {
    NAL.call_('count_cards',[NAL.swMagic()]).then( res => {
      if (!(res instanceof Array)) return;  // 'NONE' or meet error
      
      res.sort((a,b) => a[0] >= b[0]? 1: -1);
      curr_hostcard = res;
      updatePage(currIdx);
    });
  }
  else updatePage(currIdx);
  
  function updatePage(currIdx) {
    let pgNum = Math.ceil(curr_hostcard.length / 10);  // maybe 0
    if (pgNum <= 0) {
      $('#no-hostcard-area').removeClass('d-none');
      $('#hostcard-table-area, #hostcard-page-area, #hostcard-info-area, #hostcard-op-area').addClass('d-none');
      return;
    }
    
    if (currIdx < 0) currIdx = pgNum - 1;
    currIdx = Math.max(0,Math.min(currIdx,pgNum-1));
    hostcard_pg_idx = currIdx;
    
    let sHtml = '';
    let hostList = curr_hostcard.slice(currIdx*10,currIdx*10+10); // 10 items every page
    for (let i=0,hostItem; hostItem=hostList[i]; i++) {
      let host = hostItem[0], card = hostItem[1];
      sHtml += '<a class="list-group-item list-group-item-action" data-name="' + host + '" data-bs-toggle="list" role="tab"><div class="d-flex w-100 justify-content-between">';
      sHtml += '<p class="mb-0">' + htmlEscape(host) + '</p>';
      sHtml += `<p>护照:${card.pspt||0} 签证:${card.visa||0} 绿卡:${card.gncd||0}</p>`;
      sHtml += '</div></a>\n';
    }
    
    let sPage = '<li class="page-item"><a class="page-link" data-flag="RENEW">刷新</a></li>';
    sPage += '<li class="page-item"><a class="page-link" data-flag="FIRST">首页</a></li>';
    if (pgNum <= 3) {
      for (let i=0; i < pgNum; i++) {
        sPage += pageOfIndex(i,currIdx);
      }
    }
    else {  // pgNum >= 4
      if (currIdx >= 3) sPage += pageOfIndex(-1,currIdx);
      
      if (currIdx >= 2)
        sPage += pageOfIndex(currIdx-2,currIdx);
      if (currIdx >= 1)
        sPage += pageOfIndex(currIdx-1,currIdx);
      sPage += pageOfIndex(currIdx,currIdx);
      if (currIdx + 1 < pgNum)
        sPage += pageOfIndex(currIdx+1,currIdx);
      if (currIdx + 2 < pgNum)
        sPage += pageOfIndex(currIdx+2,currIdx);
      
      if (currIdx + 3 < pgNum) sPage += pageOfIndex(-1,currIdx);
    }
    sPage += '<li class="page-item"><a class="page-link" data-flag="LAST">尾页</a></li>';
    
    $('#hostcard-table-area').removeClass('d-none').html(sHtml);
    $('#hostcard-page-area').removeClass('d-none');
    $('#hostcard-page-area .pagination').html(sPage);
    
    $('#no-hostcard-area, #hostcard-info-area, #hostcard-op-area').addClass('d-none');
  }
  
  function pageOfIndex(i, currIdx) {
    let cls = 'page-item', desc = (i+1) + '';
    if (i < 0) {
      cls += ' disabled';
      desc = '..';
    }
    if (i == currIdx) cls += ' active';
    return '<li class="' + cls + '"><a class="page-link" data-flag="' + i + '">' + desc + '</a></li>';
  }
}

//---- list and show strategy

var recent_webs_idx = 0;
var recent_websites = [];

function updateWebsitePage(newPageIdx) {
  let pgNum = Math.ceil(recent_websites.length / 10);
  if (pgNum <= 0) {
    $('#website-table-area, #website-page-area, #website-info-area').addClass('d-none');
    return;
  }
  
  let currIdx = (typeof newPageIdx == 'number')? newPageIdx: recent_webs_idx;
  currIdx = Math.max(pgNum-1,currIdx);
  
  let sHtml = '', counter = 0;
  for (let i=currIdx*10,cfg; cfg=recent_websites[i]; i++) {
    if (++counter > 10) break;
    
    let name = cfg[0], tm = cfg[1], roles = cfg[2];
    tm = (new Date(tm * 1000)).toLocaleString();
    let roleDesc = roles.join(', ');
    if (roleDesc) roleDesc = htmlEscape('角色: ' + roleDesc);
    
    sHtml += '<a class="list-group-item list-group-item-action" data-name="' + name + '" data-bs-toggle="list" role="tab"><div class="d-flex w-100 justify-content-between">';
    sHtml += '<p class="mb-0">' + htmlEscape(name) + '</p>';
    sHtml += '<small>' + tm + '</small></div>';
    sHtml += '<p class="mb-0 text-truncate">' + roleDesc + '</p></a>';
  }
  
  let sPage = '<li class="page-item"><a class="page-link" data-flag="RENEW">刷新</a></li>';
  sPage += '<li class="page-item"><a class="page-link" data-flag="FIRST">首页</a></li>';
  if (pgNum <= 3) {
    for (let i=0; i < pgNum; i++) {
      sPage += pageOfIndex(i,currIdx);
    }
  }
  else {  // pgNum >= 4
    if (currIdx >= 3) sPage += pageOfIndex(-1,currIdx);
    
    if (currIdx >= 2)
      sPage += pageOfIndex(currIdx-2,currIdx);
    if (currIdx >= 1)
      sPage += pageOfIndex(currIdx-1,currIdx);
    sPage += pageOfIndex(currIdx,currIdx);
    if (currIdx + 1 < pgNum)
      sPage += pageOfIndex(currIdx+1,currIdx);
    if (currIdx + 2 < pgNum)
      sPage += pageOfIndex(currIdx+2,currIdx);
    
    if (currIdx + 3 < pgNum) sPage += pageOfIndex(-1,currIdx);
  }
  sPage += '<li class="page-item"><a class="page-link" data-flag="LAST">尾页</a></li>';
  
  $('#website-table-area').removeClass('d-none').html(sHtml);
  $('#website-page-area').removeClass('d-none');
  $('#website-page-area .pagination').html(sPage);
  $('#website-info-area').addClass('d-none');
  
  recent_webs_idx = currIdx;
  
  function pageOfIndex(i, currIdx) {
    let cls = 'page-item', desc = (i+1) + '';
    if (i < 0) {
      cls += ' disabled';
      desc = '..';
    }
    if (i == currIdx) cls += ' active';
    return '<li class="' + cls + '"><a class="page-link" data-flag="' + i + '">' + desc + '</a></li>';
  }
}

function tryRenewWebList(resetPage) {
  NAL.call('list_website',[NAL.swMagic()]).then( res => {
    if (res instanceof Array) {
      recent_websites = res;
      updateWebsitePage(resetPage?0:null);
    }
  });
}

//---- list and show sign history

var recent_sign_idx = 0;
var recent_signlist = [];

function updateSignListPage(newPageIdx) {
  let pgNum = Math.ceil(recent_signlist.length / 10);
  if (pgNum <= 0) {
    $('#no-signlist-area').removeClass('d-none');
    $('#signlist-table-area, #signlist-page-area, #signlist-info-area').addClass('d-none');
    return;
  }
  
  let currIdx = (typeof newPageIdx == 'number')? newPageIdx: recent_sign_idx;
  currIdx = Math.max(pgNum-1,currIdx);
  
  let sHtml = '', counter = 0;
  for (let i=currIdx*10,cfg; cfg=recent_signlist[i]; i++) {
    if (++counter > 10) break;
    
    let desc, id = cfg[0], child = cfg[1], tm = cfg[2], realm = cfg[3];
    let bb = child.split(',');
    let child1 = parseInt(bb[0]);
    if (bb.length >= 3)
      desc = '隐身份: ' + child1;
    else if (child1 >= 0x80000000)
      desc = '元身份: ' + (child1 & 0x7fffffff);
    else desc = '泛身份: ' + child1;
    tm = (new Date(tm * 1000)).toLocaleString();
    
    sHtml += '<a class="list-group-item list-group-item-action" data-name="' + id + '" data-bs-toggle="list" role="tab"><div class="d-flex w-100 justify-content-between">';
    sHtml += '<p class="mb-0">' + htmlEscape(desc) + '</p>';
    sHtml += '<small>' + tm + '</small></div>';
    sHtml += '<p class="mb-0 text-truncate">' + htmlEscape(realm) + '</p></a>';
  }
  
  let sPage = '<li class="page-item"><a class="page-link" data-flag="RENEW">刷新</a></li>';
  sPage += '<li class="page-item"><a class="page-link" data-flag="FIRST">首页</a></li>';
  if (pgNum <= 3) {
    for (let i=0; i < pgNum; i++) {
      sPage += pageOfIndex(i,currIdx);
    }
  }
  else {  // pgNum >= 4
    if (currIdx >= 3) sPage += pageOfIndex(-1,currIdx);
    
    if (currIdx >= 2)
      sPage += pageOfIndex(currIdx-2,currIdx);
    if (currIdx >= 1)
      sPage += pageOfIndex(currIdx-1,currIdx);
    sPage += pageOfIndex(currIdx,currIdx);
    if (currIdx + 1 < pgNum)
      sPage += pageOfIndex(currIdx+1,currIdx);
    if (currIdx + 2 < pgNum)
      sPage += pageOfIndex(currIdx+2,currIdx);
    
    if (currIdx + 3 < pgNum) sPage += pageOfIndex(-1,currIdx);
  }
  sPage += '<li class="page-item"><a class="page-link" data-flag="LAST">尾页</a></li>';
  
  $('#no-signlist-area').addClass('d-none');
  
  $('#signlist-table-area').removeClass('d-none').html(sHtml);
  $('#signlist-page-area').removeClass('d-none');
  $('#signlist-page-area .pagination').html(sPage);
  $('#signlist-info-area').addClass('d-none');
  
  recent_sign_idx = currIdx;
  
  function pageOfIndex(i, currIdx) {
    let cls = 'page-item', desc = (i+1) + '';
    if (i < 0) {
      cls += ' disabled';
      desc = '..';
    }
    if (i == currIdx) cls += ' active';
    return '<li class="' + cls + '"><a class="page-link" data-flag="' + i + '">' + desc + '</a></li>';
  }
}

function tryRenewSignList(resetPage) {
  NAL.call('list_signature',[NAL.swMagic()]).then( res => {
    if (res instanceof Array) {
      recent_signlist = res;
      updateSignListPage(resetPage?0:null);
    }
  });
}

$( () => {
  $('#btn-refresh-hostcard').on('click', ev => {
    jumpHostcardPage(0,true);
  });
  
  $('#hostcard-table-area').on('click', ev => {
    let itemNode = $(ev.target).parents('.list-group-item');
    if (itemNode.length == 0) return;
    let host = itemNode.data('name');
    if (!host) return;
    
    NAL.call_('list_cards',[NAL.swMagic(),true,null,host]).then( res => {
      if (!(res instanceof Array)) return;
      
      let sHtml = '';
      res.forEach( (card,idx) => {
        let cardDesc, cardChild = parseInt(card.child);
        if (card.flag == 'pspt') {
          if (cardChild >= 0x80000000) {
            cardDesc = '元护照';
            cardChild -= 0x80000000;
          }
          else cardDesc = '泛护照';
        }
        else if (card.flag == 'visa')
          cardDesc = '签证';
        else if (card.flag == 'gncd')
          cardDesc = '绿卡';
        else return;  // it should not happen
        
        let pubkey = card.pubkey || '';
        if (pubkey) {
          let fp = ripemdHash(Buffer.from(pubkey,'hex')).slice(0,4).toString('hex');
          pubkey = '公钥指纹: ' + parseInt(fp,16) + '<br>';
        }
        else pubkey = '';
        
        let role = '', roleDesc = '';
        if (card.flag != 'pspt') {
          role = card.role || '';
          roleDesc = `授权角色: ${role}<br>`;
        }
        let comeFrom = card.comefrom || 'myself';
        let expired = (new Date(Math.abs(card.expired) * 1000)).toLocaleString();
        
        sHtml += `<div class="hostcard-item" data-host="${card.host}" data-role="${role}" data-flag="${card.flag}" data-child="${card.child}" data-content="${card.content}">${cardDesc}: ${cardChild}, 来自 ${comeFrom}<br>${roleDesc}${pubkey}过期时间: ${expired}<br><a class="card-rmv" href="javascript:void(0)">移除本项</a> &nbsp; <a class="card-copy" href="javascript:void(0)">拷贝本项</a></div>`;
      });
      
      $('#hostcard-info-area').removeClass('d-none').html(sHtml).data('name',host);
      $('#hostcard-op-area').removeClass('d-none');
    });
  });
  
  $('#hostcard-page-area .pagination').on('click', ev => {
    let targNode = $(ev.target);
    if (!targNode.hasClass('page-link')) return;
    
    let flag = targNode.data('flag');
    if (flag == 'RENEW') {
      jumpHostcardPage(0,true);
    }
    else {
      if (!curr_hostcard.length) return;
      
      if (flag == 'FIRST')
        jumpHostcardPage(0,false);
      else if (flag == 'LAST')
        jumpHostcardPage(-1,false);
      else {
        flag = parseInt(flag);
        if (typeof flag == 'number')
          jumpHostcardPage(flag,false);
      }
    }
  });
  
  $('#hostcard-info-area').on('click', ev => {
    let targ = $(ev.target);
    let isRmv = targ.hasClass('card-rmv'), isCopy = targ.hasClass('card-copy');
    if (!isRmv && !isCopy) return;
    
    let cardNode = targ.parents('.hostcard-item');
    if (!cardNode.length) return;
    
    let cardHost = cardNode.data('host');
    let cardFlag = cardNode.data('flag');
    let cardRole = cardNode.data('role');
    let cardChild = cardNode.data('child')+''; // force as string
    let cardContent = cardNode.data('content');
    
    if (!cardChild || !cardContent) return; // unexpected error
    
    if (isRmv) {
      NAL.call_('remove_card',[NAL.swMagic(),cardHost,cardFlag,cardRole,cardChild]).then( res => {
        if (res === 'OK') {
          cardNode.remove();
          alert('成功移除项目');
        }
        else {
          console.log('remove card failed: ' + res);
          alert('移除项目失败');
        }
      });
    }
    else { // isCopy
      let bb = cardChild.split(',');   // child1,child2,child3
      let prefix = Buffer.alloc(12,0);
      prefix.writeUInt32BE(parseInt(bb[0]),0);
      prefix.writeUInt32BE(bb.length >= 2?parseInt(bb[1]):0,4);
      prefix.writeUInt32BE(bb.length >= 3?parseInt(bb[2]):0,8);
      
      let buf = Buffer.concat([prefix,Buffer.from(cardContent,'hex')]);
      let crc = CreateHash('sha256').update(buf).digest().slice(0,4);
      let txt = Buffer.concat([buf,crc]).toString('hex');
      
      let edtNode = $('#edt-card-ctx');
      edtNode.val(txt);
      edtNode.select();
      document.execCommand('copy');
      alert('卡证已拷贝');
    }
  });
  
  $('#btn-add-card').on('click', ev => {
    let host = $('#hostcard-info-area').data('name');
    if (!host) return;
    
    $('#dlg-btn-addcard').data('host',host)
    _addCardModal.show();
  });
  
  $('#dlg-btn-addcard').on('click', ev => {
    let targHost = $('#dlg-btn-addcard').data('host');
    if (!targHost) return;
    
    let cardContent = $('#addcard-content').val().trim().toLowerCase();
    if (!cardContent) return alert('请输入或粘贴卡证内容');
    
    let child,child2,child3, flag, role, succ = true;
    try {
      let buf = Buffer.from(cardContent,'hex');
      flag = buf.slice(12,16).toString('utf-8');
      if (flag != 'pspt' && flag != 'visa' && flag != 'gncd')
        succ = false;
      else {
        let crc = CreateHash('sha256').update(buf.slice(0,-4)).digest().slice(0,4).toString('hex');
        if (crc != buf.slice(-4).toString('hex'))
          return alert('卡证校验不通过');
        
        child = buf.readUInt32BE(0);
        child2 = buf.readUInt32BE(4);
        child3 = buf.readUInt32BE(8);
        buf = buf.slice(12,-4);
        
        let realm = scanCardTag(buf,0xc8)  // 0xc8 is TAG_REALM
        if (!realm)
          succ = false;  // realm is required
        else {
          role = realm.toString('utf-8').split('+')[1] || '';
          cardContent = buf.toString('hex');
        }
      }
    }
    catch(e) {
      succ = false;
    }
    if (!succ) return alert('卡证格式不正确');
    
    let comefrom = $('#addcard-auth').val().trim();
    let children = child + '';
    if (flag == 'gncd') children += ',' + child2 + ',' + child3;
    NAL.call_('save_card',[NAL.swMagic(),flag,role,children,cardContent,comefrom,targHost]).then( res => {
      let cardDesc = flag == 'pspt'? '护照': (flag == 'visa'? '签证': '绿卡');
      if (res === 'OK') {
        $('#addcard-auth').val('');
        $('#addcard-content').val('');
        _addCardModal.hide();
        setTimeout(() => alert(`卡证（${cardDesc}）已成功添加`),300);
      }
      else alert(`保存卡证（${cardDesc}）失败`);
    });
  });
  
  //----
  
  $('#website-table-area').on('click', ev => {
    let itemNode = $(ev.target).parents('.list-group-item');
    if (itemNode.length == 0) return;
    let name = itemNode.data('name');
    if (!name) return;
    
    if (name == NAL.swHost())
      hideWebStrategy();
    else showWebStrategy(name);
    
    function showWebStrategy(hostname) {
      NAL.call('web_strategy',[NAL.swMagic(),hostname]).then( res => {
        if (typeof res == 'string') {
          hideWebStrategy();
          return;
        }
        
        let s = '<code><pre>' + JSON.stringify(res,null,2) + '</pre></code>';
        $('#website-info-area').removeClass('d-none').html(s);
      });
    }
    
    function hideWebStrategy() {
      $('#website-info-area').addClass('d-none').html('');
    }
  });
  
  $('#website-page-area .pagination').on('click', ev => {
    let targNode = $(ev.target);
    if (!targNode.hasClass('page-link')) return;
    
    let flag = targNode.data('flag');
    if (flag == 'RENEW')
      tryRenewWebList(false);
    else {
      if (flag == 'FIRST')
        updateWebsitePage(0);
      else if (flag == 'LAST')
        updateWebsitePage(Math.ceil(recent_websites.length/10)-1);
      else {
        flag = parseInt(flag);
        if (typeof flag == 'number')
          updateWebsitePage(flag);
      }
    }
  });
  
  //----
  
  $('#btn-refresh-signlist').on('click', ev => {
    tryRenewSignList(true);
  });
  
  $('#signlist-table-area').on('click', ev => {
    let itemNode = $(ev.target).parents('.list-group-item');
    if (itemNode.length == 0) return;
    let name = itemNode.data('name');
    if (!name) return;
    
    showSignListItem(parseInt(name));
    
    function showSignListItem(itemId) {
      NAL.call('get_signed_item',[NAL.swMagic(),itemId]).then( res => {
        if (!(res instanceof Array)) {
          hideSignListItem();
          return;
        }
        
        // res should be [child,sign_tm,realm,pubkey,content,signature]
        let tm = (new Date(res[1] * 1000)).toLocaleString();
        let pubkey = Buffer.from(res[3],'hex');
        let fp = ripemdHash(pubkey).slice(0,4);
        let s = '<span>账号指纹：' + parseInt(fp.toString('hex'),16) + '</span><br>';
        s += '<span>账号公钥：' + htmlEscape(res[3]) + '</span><br>';
        s += '<span>授权领域：' + htmlEscape(res[2]) + '</span><br>';
        s += '<span>授权时间：' + tm + '</span><br>';
        s += '<span>授权内容：' + htmlEscape(res[4]) + '</span><br>';
        s += '<span>授权签名：' + htmlEscape(res[5]) + '</span>';
        $('#signlist-info-area').removeClass('d-none').html(s);
      });
    }
    
    function hideSignListItem() {
      $('#signlist-info-area').addClass('d-none').html('');
    }
  });
  
  $('#signlist-page-area .pagination').on('click', ev => {
    let targNode = $(ev.target);
    if (!targNode.hasClass('page-link')) return;
    
    let flag = targNode.data('flag');
    if (flag == 'RENEW')
      tryRenewSignList(false);
    else {
      if (flag == 'FIRST')
        updateSignListPage(0);
      else if (flag == 'LAST')
        updateSignListPage(Math.ceil(recent_signlist.length/10)-1);
      else {
        flag = parseInt(flag);
        if (typeof flag == 'number')
          updateSignListPage(flag);
      }
    }
  });
});
</script>

</body>
</html>
